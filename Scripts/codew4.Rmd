---
title: "codew4"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(stargazer)
library(ggrepel)

# Datasets read in

popvote_df    <- read_csv("../Data/popvote_1948-2016.csv")
pvstate_df    <- read_csv("../Data/popvote_bystate_1948-2016.csv")
economy_df    <- read_csv("../Data/econ.csv")
approval_df   <- read_csv("../Data/approval_gallup_1941-2020.csv")
pollstate_df  <- read_csv("../Data/pollavg_bystate_1968-2016.csv")
fedgrants_df  <- read_csv("../Data/fedgrants_bystate_1988-2008.csv")

# Time for change dataset from section data:

tfc_df <- popvote_df %>%
  filter(incumbent_party) %>%
  select(year, candidate, party, pv, pv2p, incumbent) %>%
  inner_join(
    approval_df %>% 
      group_by(year, president) %>% 
      slice(1) %>% 
      mutate(net_approve=approve-disapprove) %>%
      select(year, incumbent_pres=president, net_approve, poll_enddate),
    by="year"
  ) %>%
  inner_join(
    economy_df %>%
      filter(quarter == 2) %>%
      select(GDP_growth_qt, year),
    by="year"
  )

# Create the time for change model.

tfc_real <- lm(pv2p ~ net_approve + GDP_growth_qt + incumbent, data=tfc_df)

summary(tfc_real)

# Then make a table comparing coefficient values - fairly close.

# use GT

# Graph the errors

actual <- popvote_df %>% 
  filter(incumbent_party == TRUE) %>% 
  select(year, pv2p)

predict(tfc_real)

tfc_error <- data.frame(predictions = predict(tfc_real), actual = actual$pv2p, year = actual$year)

ggplot(tfc_error, aes(x=predictions, y=actual)) +
  geom_text(aes(label=year)) +
  geom_abline(slope=1, intercept=0, color="salmon") +
  xlim(40, 60) +
  ylim(40, 60) +
  labs(title = "Evaluating the Time-for-Change Model", subtitle = "Mean Squared Error of _", x="Predicted Incumbent Party Vote Share", y="Actual Incumbent Party Vote Share")

# Compare to model from last week. Only change is incumbent_party into incumbent.

model_3_data <- read_csv("../Data/model_3.csv") %>% 
  filter(incumbent_party == TRUE,
         year > 1968)

mprev_3 <- lm(pv2p ~ unemployment_nat_t + GDP_growth_a + incumbent, data=model_3_data)
summary(mprev_3)

m10_3 <- lm(pv2p ~ avg_support_10 + margin_pct_lag_nat + RDI_growth_t + incumbent, data=model_3_data)
summary(m10_3)

m2_3 <- lm(pv2p ~ avg_support_2 + margin_pct_lag_nat + RDI_growth_t + incumbent, data=model_3_data)
summary(m2_3)

model_3_predictions <- data.frame(fundamentals = predict(mprev_3), tenweek = predict(m10_3), twoweek = predict(m2_3), actual = actual$pv2p[actual$year>1968], year = actual$year[actual$year>1968]) %>% 
  mutate(ensemble = fundamentals/3 + tenweek/3 + twoweek/3)

ggplot(model_3_predictions, aes(x=ensemble, y=actual)) +
  geom_text(aes(label=year)) +
  geom_abline(slope=1, intercept=0, color="salmon") +
  xlim(40, 60) +
  ylim(40, 60) +
  labs(title = "Evaluating the Ensemble Model", subtitle = "Mean Squared Error of _", x="Predicted Incumbent Party Vote Share", y="Actual Incumbent Party Vote Share")
```

